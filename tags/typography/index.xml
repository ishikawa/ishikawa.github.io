<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Typography on METAREAL</title>
    <link>http://ishikawa.github.io/tags/typography/</link>
    <description>Recent content in Typography on METAREAL</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja-JP</language>
    <copyright>copyright © 2006-Present Takanori Ishikawa.</copyright>
    <lastBuildDate>Sat, 08 Nov 2008 03:00:00 +0900</lastBuildDate>
    <atom:link href="http://ishikawa.github.io/tags/typography/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Cocoa で独自の Text View を実装する</title>
      <link>http://ishikawa.github.io/2008/11/08/cocoa-custom-text-view/</link>
      <pubDate>Sat, 08 Nov 2008 03:00:00 +0900</pubDate>
      
      <guid>http://ishikawa.github.io/2008/11/08/cocoa-custom-text-view/</guid>
      <description>

&lt;p&gt;&lt;a href=&#34;http://developer.apple.com/iphone/program/&#34;&gt;iPhone&lt;/a&gt; も盛り上がっていることだし、ひさしぶりに &lt;a href=&#34;http://developer.apple.com/referencelibrary/Cocoa/&#34;&gt;Cocoa&lt;/a&gt; プログラミングを始めてみる。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://developer.apple.com/mac/&#34;&gt;Mac Dev Center&lt;/a&gt; をつらつらと眺めてみると、&lt;a href=&#34;http://developer.apple.com/mac/articles/cocoa/managingconcurrency.html&#34;&gt;Managing Concurrency with NSOperation&lt;/a&gt; という記事に興味が湧く。&lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/NSOperation_class/Reference/Reference.html&#34;&gt;NSOperation&lt;/a&gt; と &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/NSOperationQueue_class/Reference/Reference.html&#34;&gt;NSOperationQueue&lt;/a&gt;（優先順位付きキュー）を使うことで、タスクのスケジューリングと並行処理が手軽に行えるようになったようだ。Java の &lt;a href=&#34;http://java.sun.com/javase/6/docs/api/java/util/concurrent/package-summary.html&#34;&gt;concurrency パッケージ&lt;/a&gt;に感銘を受けた身としては、こういう拡張は嬉しい。今後、マルチスレッドが必要になったときに、改めて詳しく調べてみよう。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://developer.apple.com/referencelibrary/Cocoa/idxTextFonts-date.html&#34;&gt;テキストシステム周り&lt;/a&gt;も、ひところに比べると充実してきている。Mac OS X 10.3 では &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSATSTypesetter_Class/Reference/Reference.html&#34;&gt;NSATSTypesetter&lt;/a&gt; が公開された。更に Mac OS X 10.5 では &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/NSTextInputClient_Protocol/Reference/Reference.html&#34;&gt;NSTextInputClient&lt;/a&gt; プロトコルと &lt;a href=&#34;http://developer.apple.com/releasenotes/Cocoa/RN-InputMethodKit/index.html&#34;&gt;Input Method Kit&lt;/a&gt; が追加されている（他にもあるかも）。&lt;/p&gt;

&lt;p&gt;さて、Cocoa プログラミングのリハビリとして、今回は独自の Text View を実装してみようと思う。&lt;/p&gt;

&lt;p&gt;ここでいう Text View とは &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSTextView_Class/Reference/Reference.html&#34;&gt;NSTextView&lt;/a&gt; のように、IM からの入力を受け取り、テキストを表示、編集できるクラスのことだ。エディタやワープロといったアプリケーションを開発するときには必要になってくるだろう。&lt;/p&gt;

&lt;h3 id=&#34;nsview-のサブクラス:11812e693eeb5d1ecb4e7b72cbcfa22b&#34;&gt;NSView のサブクラス&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Conceptual/InputManager/Tasks/TextViewTask.html#//apple_ref/doc/uid/20001040&#34;&gt;ドキュメント&lt;/a&gt;によると、独自の Text View を実装する場合は &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSTextView_Class/Reference/Reference.html&#34;&gt;NSTextView&lt;/a&gt; のサブクラスか、&lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSView_Class/Reference/NSView.html&#34;&gt;NSView&lt;/a&gt; のサブクラスを作るようなので、今回は NSView のサブクラスとして作成することにする。&lt;/p&gt;

&lt;p&gt;&lt;code&gt;NSView&lt;/code&gt; のサブクラスを作るとして、名前は単純に &lt;code&gt;MyTextView&lt;/code&gt; としよう。まずは &lt;code&gt;MyTextView.h&lt;/code&gt; で、クラスの &lt;code&gt;@interface&lt;/code&gt; を書く。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-objc&#34;&gt;#import &amp;amp;lt;Cocoa/Cocoa.h&amp;amp;gt;

@interface MyTextView : NSView {
  NSMutableAttributedString *_text;
}
@end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;インスタンス変数として &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/Foundation/Classes/NSMutableAttributedString_Class/Reference/Reference.html&#34;&gt;NSMutableAttributedString&lt;/a&gt; をひとつ持つ。ここに表示、編集するテキストの内容を保持するわけだ（MVC も糞もない設計だが、今回のはあくまで例なので単純さを優先する）。&lt;/p&gt;

&lt;h3 id=&#34;first-responder:11812e693eeb5d1ecb4e7b72cbcfa22b&#34;&gt;First Responder&lt;/h3&gt;

&lt;p&gt;最初にすることは、このクラスがキー入力を受け取れるようにすることだ。そのためには、キー入力やマウスクリックなどのイベントを受け取るれるように、&lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSResponder_Class/Reference/Reference.html#//apple_ref/occ/instm/NSResponder/acceptsFirstResponder&#34;&gt;acceptsFirstResponder&lt;/a&gt; をオーバーライドする必要がある。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-objc&#34;&gt;- (BOOL) acceptsFirstResponder {
  return YES;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;さて、これでキー入力イベントを受け取れるようになったので、今度は &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSResponder_Class/Reference/Reference.html#//apple_ref/occ/instm/NSResponder/keyDown:&#34;&gt;keyDown:&lt;/a&gt; を実装しよう。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-objc&#34;&gt;- (void) keyDown: (NSEvent *) theEvent {
  [self interpretKeyEvents: [NSArray arrayWithObject: theEvent]];
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;これだけ。そのまま &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSResponder_Class/Reference/Reference.html#//apple_ref/occ/instm/NSResponder/interpretKeyEvents:&#34;&gt;interpretKeyEvents:&lt;/a&gt; に投げている。&lt;/p&gt;

&lt;h3 id=&#34;interpretkeyevents:11812e693eeb5d1ecb4e7b72cbcfa22b&#34;&gt;interpretKeyEvents:&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;interpretKeyEvents:&lt;/code&gt; は &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSInputManager_Class/Reference/Reference.html#//apple_ref/occ/cl/NSInputManager&#34;&gt;NSInputManager&lt;/a&gt; を通して、最終的に、ビューの &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSResponder_Class/Reference/Reference.html#//apple_ref/occ/instm/NSResponder/insertText:&#34;&gt;insertText:&lt;/a&gt; や &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSResponder_Class/Reference/Reference.html#//apple_ref/occ/instm/NSResponder/insertNewline:&#34;&gt;insertNewline:&lt;/a&gt; などを呼び出すので、あとはこれらのメソッドを実装すればいい。&lt;/p&gt;

&lt;p&gt;今回は改行、タブ、削除、通常のテキスト入力など、最低限必要なメソッドだけを実装している。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-objc&#34;&gt;- (void) deleteBackward: (id) sender {
  const NSUInteger length = [_text length];

  if (length &amp;amp;gt; 0) {
    [_text deleteCharactersInRange: NSMakeRange(length - 1, 1)];
    [self setNeedsDisplay: YES];
  }
}

- (void) insertNewline: (id) sender {
  [self insertText: @&amp;quot;\n&amp;quot;];
}

- (void) insertTab: (id) sender {
  [self insertText: @&amp;quot;\t&amp;quot;];
}

- (void) insertText: (id) aString {
  [[_text mutableString] appendString: aString];
  [_text addAttribute: NSFontAttributeName
                value: [NSFont userFontOfSize: 18.0f]
                range: NSMakeRange(0, [_text length])];
  [self setNeedsDisplay: YES];
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;なお、&lt;code&gt;insertText:&lt;/code&gt; に渡される &lt;code&gt;aString&lt;/code&gt; は &lt;code&gt;NSString&lt;/code&gt; とは限らず、&lt;code&gt;NSAttributedString&lt;/code&gt; の可能性もあるので、本来はそれも考慮したコードにするべきだ。&lt;/p&gt;

&lt;h3 id=&#34;テキストの表示:11812e693eeb5d1ecb4e7b72cbcfa22b&#34;&gt;テキストの表示&lt;/h3&gt;

&lt;p&gt;最後に、描画部分を実装しよう。テキストのレイアウトと描画は &lt;code&gt;NSAttributedString&lt;/code&gt; の &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSAttributedString_AppKitAdditions/Reference/Reference.html#//apple_ref/occ/instm/NSAttributedString/drawInRect:&#34;&gt;drawInRect:&lt;/a&gt; に任せてしまう。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-objc&#34;&gt;- (void) drawRect: (NSRect) theRect {
  [[NSColor whiteColor] set];
  NSFrameRect(theRect);

  NSRectFill(theRect);
  [[NSColor grayColor] set];
  NSFrameRect(theRect);

  [_text drawInRect: NSMakeRect(
      theRect.origin.x + 5.0f, theRect.origin.y,
      theRect.size.width, theRect.size.height)];
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;以上で、簡単ではあるが、テキストの入力と削除が可能な Text View が出来た。&lt;/p&gt;

&lt;p&gt;日本語変換、入力など、更に複雑な操作をサポートするためには、&lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Protocols/NSTextInput_Protocol/Reference/Reference.html&#34;&gt;NSTextInput&lt;/a&gt; や、それを拡張した &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/NSTextInputClient_Protocol/Reference/Reference.html&#34;&gt;NSTextInputClient&lt;/a&gt; を実装する必要がある。更に、独自のレイアウトも実装することになるだろう。実用的な Text View を開発するのはかなりの労力がいりそうだ。&lt;/p&gt;

&lt;p&gt;なお、今回のソースコードは &lt;a href=&#34;http://gist.github.com/23017&#34;&gt;gist:23017&lt;/a&gt; に置いてある。&lt;/p&gt;

&lt;h3 id=&#34;参考:11812e693eeb5d1ecb4e7b72cbcfa22b&#34;&gt;参考&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Conceptual/EventOverview/Introduction/chapter_1_section_1.html#//apple_ref/doc/uid/10000060i-CH1-DontLinkElementID_45&#34;&gt;Cocoa Event-Handling Guide&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Conceptual/InputManager/InputManager.html#//apple_ref/doc/uid/10000065&#34;&gt;Introduction to Text Input Management&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>NSView の CGContextRef に ATSUI でテキストを描画する方法</title>
      <link>http://ishikawa.github.io/2007/01/14/rendering-unicode-text-into-cgcontextref-with-atsui/</link>
      <pubDate>Mon, 15 Jan 2007 02:00:00 +0900</pubDate>
      
      <guid>http://ishikawa.github.io/2007/01/14/rendering-unicode-text-into-cgcontextref-with-atsui/</guid>
      <description>&lt;p&gt;Cocoa の &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSView_Class/index.html?http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSView_Class/Reference/Reference.html&#34;&gt;&lt;code&gt;NSView&lt;/code&gt;&lt;/a&gt; に &lt;a href=&#34;http://developer.apple.com/documentation/Carbon/Reference/ATSUI_Reference/index.html&#34;&gt;Apple Type Services for Unicode Imaging (ATSUI)&lt;/a&gt; でテキストを描画する方法を紹介する。&lt;/p&gt;

&lt;p&gt;ATSUI では描画に Quartz の &lt;a href=&#34;http://developer.apple.com/documentation/GraphicsImaging/Reference/CGContext/Reference/reference.html#//apple_ref/doc/uid/TP30000950-CH2g-C016175&#34;&gt;&lt;code&gt;CGContextRef&lt;/code&gt;&lt;/a&gt; を設定することができる。&lt;code&gt;CGContextRef&lt;/code&gt; は &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSGraphicsContext_Class/index.html?http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSGraphicsContext_Class/Reference/Reference.html&#34;&gt;&lt;code&gt;NSGraphicsContext&lt;/code&gt;&lt;/a&gt; の &lt;code&gt;graphicsPort&lt;/code&gt; で取得できるので、以下のようなコードで設定できる。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;**CGContextRef context = [[NSGraphicsContext currentContext] graphicsPort];**
ATSUAttributeTag tags[] = { kATSUCGContextTag };
ByteCount sizes[] = { sizeof(CGContextRef) };
ATSUAttributeValuePtr values[] = { **&amp;amp;context** };
ATSUSetLayoutControls(layout, 1, tags, sizes, values);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;以下のコードでは、&lt;code&gt;NSView&lt;/code&gt; の &lt;code&gt;drawRect:&lt;/code&gt; で Hello, World を描画している。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;- (void) drawRect : (NSRect) rect
{
  NSString *s = @&amp;quot;Hello, World!&amp;quot;;
  UniChar *text;
  UniCharCount length;
  ATSUStyle style;
  ATSUTextLayout layout;

  // Setup
  ATSUCreateStyle(&amp;amp;style);
  ATSUCreateTextLayout(&amp;amp;layout);

  length = [s length];
  text = (UniChar *)malloc(length * sizeof(UniChar));
  [s getCharacters:text];

  ATSUSetTextPointerLocation(
    layout,
    text,
    kATSUFromTextBeginning,
    kATSUToTextEnd,
    length);
  ATSUSetRunStyle(
    layout,
    style,
    kATSUFromTextBeginning,
    kATSUToTextEnd
  );

  // CGContext
  CGContextRef context = [[NSGraphicsContext currentContext] graphicsPort];
  ATSUAttributeTag tags[] = { kATSUCGContextTag };
  ByteCount sizes[] = { sizeof(CGContextRef) };
  ATSUAttributeValuePtr values[] = { &amp;amp;context };
  ATSUSetLayoutControls(layout, 1, tags, sizes, values);

  // Drawing
  ATSUDrawText(
    layout,
    kATSUFromTextBeginning,
    kATSUToTextEnd,
    X2Fix(10.0f),
    X2Fix(10.0f));

  free(text);
  ATSUDisposeStyle(style);
  ATSUDisposeTextLayout(layout);
}
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Interface Builder の NSTextView で NSLayoutManager を置き換える</title>
      <link>http://ishikawa.github.io/2007/01/14/how-to-replace-layout-manager/</link>
      <pubDate>Sun, 14 Jan 2007 10:01:00 +0900</pubDate>
      
      <guid>http://ishikawa.github.io/2007/01/14/how-to-replace-layout-manager/</guid>
      <description>&lt;p&gt;Cocoa の &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSLayoutManager_Class/Reference/Reference.html&#34;&gt;&lt;code&gt;NSLayoutManager&lt;/code&gt;&lt;/a&gt; や &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSTypesetter_Class/Reference/Reference.html&#34;&gt;&lt;code&gt;NSTypesetter&lt;/code&gt;&lt;/a&gt; をサブクラス化したい場合、Apple のドキュメント &amp;ldquo;&lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Conceptual/TextArchitecture/index.html?http://developer.apple.com/documentation/Cocoa/Conceptual/TextArchitecture/Tasks/TextEditor.html&#34;&gt;Assembling the Text System by Hand&lt;/a&gt;&amp;rdquo; にあるように、マニュアルで &lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Reference/ApplicationKit/Classes/NSTextView_Class/Reference/Reference.html&#34;&gt;&lt;code&gt;NSTextView&lt;/code&gt;&lt;/a&gt; を構築してもいいが面倒だ。それに、このままではスクロールビューでデコレートもされてないのでノーグッド。&lt;/p&gt;

&lt;p&gt;どうせなら、Interface Builder で配置した &lt;code&gt;NSTextView&lt;/code&gt; の &lt;code&gt;NSLayoutManager&lt;/code&gt; を置き換えるのが手っ取り早いだろう。コードは以下のようになる。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;- (void) awakeFromNib {
  _textStorage = [[NSTextStorage alloc] initWithString:@&amp;quot;Cocoa Programming Topics&amp;quot;];

  NSLayoutManager *layoutManager = [[MyLayoutManager alloc] init];
  [_textStorage addLayoutManager:layoutManager];
  [layoutManager release];

**  NSTextContainer *textContainer = [_textView textContainer];
  [layoutManager addTextContainer:textContainer];
  [textContainer replaceLayoutManager:layoutManager];
**}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;肝になるのは &lt;code&gt;NSLayoutManager&lt;/code&gt; の &lt;code&gt;addTextContainer:&lt;/code&gt; で元々の &lt;code&gt;NSTextContainer&lt;/code&gt; を追加したあとに、&lt;code&gt;NSTextContainer&lt;/code&gt; の &lt;code&gt;replaceLayoutManager:&lt;/code&gt; を呼ぶこと。これで &lt;code&gt;NSLayoutManager&lt;/code&gt; を置き換えられる。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Cocoa の Text System を勉強中</title>
      <link>http://ishikawa.github.io/2007/01/06/learning-cocoa-text-system/</link>
      <pubDate>Sun, 07 Jan 2007 04:13:00 +0900</pubDate>
      
      <guid>http://ishikawa.github.io/2007/01/06/learning-cocoa-text-system/</guid>
      <description>&lt;p&gt;Mac OS X のフレームワークである Cocoa の Text System を調べるため、ドキュメントを漁り中。&lt;/p&gt;

&lt;p&gt;そのなかで、&lt;a href=&#34;http://developer.apple.com/documentation/Cocoa/Conceptual/TextArchitecture/Concepts/TextSystemFeatures.html#//apple_ref/doc/uid/20001800&#34;&gt;Text System Overview: Typographical Features of the Cocoa Text System&lt;/a&gt; の画像 &lt;strong&gt;Figure 4&lt;/strong&gt; は、&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://developer.apple.com/documentation/Carbon/Conceptual/ATSUI_Concepts/atsui_chap2/chapter_2_section_6.html&#34;&gt;Rendering Unicode Text With ATSUI: Text Measurements&lt;/a&gt; の &lt;strong&gt;Figure 1-4&lt;/strong&gt; を使うのが適切な気がする。前者だと、垂直方向の例がないので。&lt;/p&gt;

&lt;p&gt;というか、Cocoa の Text System を理解するには ATSUI も勉強した方がいいのか？　うーん、大変そうだ。&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>