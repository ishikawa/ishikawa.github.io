<!doctype html>
<html class="no-js" lang="ja">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <base href="http://www.metareal.org/">
  <title>Django のモデルで日本語を使うと UnicodeEncodeError が発生する</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="canonical" href="http://www.metareal.org/2008/04/11/django-unicode-encode-error/">
  <link href="" rel="alternate" type="application/rss+xml" title="METAREAL" />
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/application.css">
  <link rel="stylesheet" href="css/highlight/tomorrow.css">
  <script src="js/vendor/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>
<body>


<article>
  <h1>Django のモデルで日本語を使うと UnicodeEncodeError が発生する</h1>
  <div class="metadata">
    <p class="date">2008/04/12 7:16am</p>
  </div>
  <div class="content">
    

<p><a href="http://diary.metareal.org/2008/01/24/meet-django-django-is-a-high-level-python-web-framework/">ちょっと前</a>から <a href="http://www.djangoproject.com/">Django</a> で遊んでいる。教則本代わりの <a href="http://www.djangobook.com/">Django Book</a> も含めて、完成度の高さに驚くことしきり。</p>

<p>ただ、実際に管理インターフェースでモデルの詳細を表示しようとすると、<strong>UnicodeEncodeError</strong> とかいう嫌らしいエラーが出て、萎える。</p>

<p>しかたなく <code>python UnicodeEncodeError django</code> で検索したら <a href="http://d.hatena.ne.jp/SumiTomohiko/20070120/1169300624">sitecustomize.py でデフォルトのエンコーディングを変更する</a>とか、いや、str 関数に渡したい場合はそりゃそうなんだろうけど、せっかくフレームワーク使ってるんだし、この解決法じゃないんだろうな、っていうのしか見つけられなくてますます萎えてたわけだけど、やっと納得できる解決法が見つかったので残しておく。</p>

<p>ちなみに <a href="#id1">``</a>svn trunk`` な Django を使っている。</p>

<p>System Message: WARNING/2 (<code>&lt;string&gt;</code>, line 7); <em>backlink</em></p>

<p>Inline literal start-string without end-string.</p>

<h3 id="モデルには-str-ではなく-unicode-を実装する:3b09cb17e796826b168e2323e1bf17ef">モデルには <strong>str</strong> ではなく <strong>unicode</strong> を実装する</h3>

<p>Django オンラインドキュメント和訳の <a href="http://michilu.com/django/doc-ja/unicode/#str-unicode"><strong>str</strong>() と <strong>unicode</strong>() のどちらを使うべきか</a>に、そのものズバリの回答があった。</p>

<blockquote>
<p>モデルに <strong>str</strong>() メソッドを定義する代わりに <strong>unicode</strong>() メソッドを実装するよう推奨します． <strong>unicode</strong>() メソッ ドの中では，モデルのフィールド値を使って好きな値を作成でき，その値がバイト 文字列として適切に表現されるかを気にせず返してかまいません</p>
</blockquote>

<p>本当だ。モデルに書いていた <strong>str</strong> メソッドを <strong>unicode</strong> に変えるだけで解決しちゃったよ。</p>

<h3 id="force-unicode:3b09cb17e796826b168e2323e1bf17ef">force_unicode</h3>

<p>エラーのスタックトレースを辿って、Django の <code>django/utils/encodings.py</code> を見てみると、</p>

<pre><code>def force_unicode(s, encoding='utf-8', strings_only=False, errors='strict'):
...
        if not isinstance(s, basestring,):
            if hasattr(s, '__unicode__'):
                s = unicode(s)
            else:
                s = unicode(str(s), encoding, errors)
</code></pre>

<p>エラーは最後の str 関数の呼び出しで起きているわけだが、その前に hasattr で <strong>unicode</strong> を調べているのが分かると思う。実をいうと上のドキュメントは、ここから <strong>unicode</strong> を検索してみて見つけたものだった。</p>

<p>しかし、改めて検索してみると常識っぽいな&hellip;。最初の検索の仕方がまずかったか。</p>

  </div>
</article>

<nav class="pagination">
  <ul>
    
    <li class="next"><i class="fa fa-angle-left"></i><a href="http://www.metareal.org/2008/04/14/python-markdown-1-7-with-django/">Django と Python-Markdown 1.7 で UnicodeDecodeError</a></li>
    
    
    <li class="prev"><a href="http://www.metareal.org/2008/04/11/building-readline-enabled-python-on-mac/">Mac の Python をビルドするときに GNU Readline ライブラリを有効にする</a><i class="fa fa-angle-right"></i></li>
    
  </ul>
</nav>

<footer>
  <ul class="about">
    <li><a href="https://twitter.com/takanori_is">Twitter</a></li>
    <li><a href="https://github.com/ishikawa">Github</a></li>
  </ul>
  <h2><a href="/">METAREAL</a></h2>
  <p class="copyright">copyright &copy; 2006-Present Takanori Ishikawa</p>
</footer>


</body>
</html>
